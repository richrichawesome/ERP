{% extends "main/base.html" %} {% block page_content %}
<style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
      sans-serif;
    background: #f8fafc;
    color: #030213;
  }

  .container {
    max-width: 1200px;
    margin: 0 auto;
  }

  .header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
  }

  .back-btn {
    padding: 10px 20px;
    background: #2563eb;
    color: white;
    text-decoration: none;
    border-radius: 4px;
    font-weight: 500;
  }

  .back-btn:hover {
    background: #1d4ed8;
  }

  /* NEW: Inspect button styling */
  .inspect-btn {
    background: #f59e0b;
    color: white;
  }

  .inspect-btn:hover {
    background: #d97706;
  }

  .card {
    background: white;
    padding: 25px;
    border-radius: 8px;
    border: 1px solid rgba(0, 0, 0, 0.1);
    margin-bottom: 20px;
    box-shadow: 0 1px 3px rgba(3, 2, 19, 0.1);
  }

  /* Progress Bar Styles */
  .progress-container {
    margin: 30px 0;
  }

  .progress-steps {
    display: flex;
    justify-content: space-between;
    position: relative;
    margin-bottom: 20px;
  }

  .progress-steps::before {
    content: "";
    position: absolute;
    top: 15px;
    left: 0;
    right: 0;
    height: 3px;
    background: #e9ebef;
    z-index: 1;
  }

  .progress-bar {
    position: absolute;
    top: 15px;
    left: 0;
    height: 3px;
    background: #2563eb;
    z-index: 2;
    transition: width 0.3s ease;
  }

  .step {
    display: flex;
    flex-direction: column;
    align-items: center;
    position: relative;
    z-index: 3;
  }

  .step-circle {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    background: #e9ebef;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    margin-bottom: 8px;
    border: 3px solid white;
  }

  .step.active .step-circle {
    background: #2563eb;
    color: white;
  }

  .step.completed .step-circle {
    background: #10b981;
    color: white;
  }

  .step-label {
    font-size: 12px;
    text-align: center;
    font-weight: 500;
    max-width: 120px;
  }

  /* Specification Display Styles */
  .specs-cell {
    max-width: 200px;
    word-wrap: break-word;
  }

  .specs-container {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .spec-item {
    padding: 2px 0;
    /* border-bottom: 1px solid #f1f1f1; */
  }

  .spec-item:last-child {
    border-bottom: none;
  }

  .spec-item strong {
    color: #030213;
    font-weight: 600;
  }

  .no-specs {
    color: #94a3b8;
    font-style: italic;
  }

  /* Ensure table cells have proper spacing */
  td {
    padding: 12px;
    border: 1px solid rgba(0, 0, 0, 0.1);
    background: #ffffff;
    vertical-align: top;
  }

  /* Table Styles */
  .table {
    width: 100%;
    border-collapse: collapse;
    background: white;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 1px 3px rgba(3, 2, 19, 0.1);
  }

  .table th {
    background: #030213;
    color: white;
    padding: 12px;
    text-align: left;
    font-weight: 600;
  }

  /* .table td {
            padding: 12px;
            border: 1px solid rgba(0, 0, 0, 0.1);
        } */

  .table tbody tr:nth-child(even) {
    background: #f8fafc;
  }

  /* Requisition Info Styles */
  .requisition-info {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-top: 20px;
  }

  .info-group {
    margin-bottom: 15px;
  }

  .info-label {
    font-weight: 600;
    color: #717182;
    font-size: 14px;
    margin-bottom: 5px;
  }

  .info-value {
    font-size: 16px;
    color: #030213;
  }

  .status-badges-container {
    display: block;
  }

  .status-badge {
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
    display: block;
    width: fit-content;
    margin-bottom: 8px;
  }

  .status-blue {
    background: #eff6ff;
    color: #1e40af;
    border: 1px solid #3b82f6;
    padding: 12px 12px;
    border-radius: 5px;
    font-size: 15px;
    font-weight: 600;
    display: block;
    width: fit-content;
  }

  .status-pending {
    background: #fef3c7;
    color: #92400e;
  }

  .status-approved {
    background: #d1fae5;
    color: #065f46;
  }

  .status-rejected {
    background: #fee2e2;
    color: #991b1b;
  }

  /* Button Styles */
  .action-buttons {
    display: flex;
    gap: 10px;
    margin-top: 20px;
    flex-wrap: wrap;
  }

  .btn {
    padding: 10px 20px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-weight: 500;
    transition: all 0.2s ease;
  }

  .reject-btn {
    background: #dc2626;
    color: white;
  }

  .reject-btn:hover {
    background: #b91c1c;
  }

  .approve-btn {
    background: #16a34a;
    color: white;
  }

  .approve-btn:hover {
    background: #15803d;
  }

  /* NEW: Received button styling */
  .received-btn {
    background: #16a34a;
    color: white;
  }

  .received-btn:hover {
    background: #15803d;
  }

  /* NEW: Received button styling */
  .delivery-received-btn {
    background: #16a34a;
    color: white;
  }

  .btn delivery-received-btn:hover {
    background: #15803d;
  }

  .complete-btn {
    background: #16a34a;
    color: white;
  }

  .btn complete-btn:hover {
    background: #15803d;
  }

  .approve-management-btn {
    background: #2563eb;
    color: white;
  }

  .approve-management-btn:hover {
    background: #1d4ed8;
  }

  /* Modal Styles */
  .modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 1000;
    align-items: center;
    justify-content: center;
  }

  .modal-content {
    background: white;
    padding: 30px;
    border-radius: 8px;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
    max-width: 500px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
  }

  .modal h3 {
    margin-bottom: 15px;
    color: #030213;
  }

  .modal p {
    margin-bottom: 20px;
    color: #717182;
  }

  .modal textarea {
    width: 100%;
    padding: 12px;
    border: 1px solid rgba(0, 0, 0, 0.1);
    border-radius: 4px;
    resize: vertical;
    min-height: 100px;
    margin-bottom: 20px;
    font-family: inherit;
  }

  .modal textarea:focus {
    outline: none;
    border-color: #2563eb;
    box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1);
  }

  .modal-actions {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
  }

  .modal-cancel {
    background: #6b7280;
    color: white;
  }

  .modal-cancel:hover {
    background: #4b5563;
  }

  .modal-confirm {
    background: #dc2626;
    color: white;
  }

  .modal-confirm.approve {
    background: #16a34a;
  }

  .modal-confirm.approve-management {
    background: #2563eb;
  }

  .modal-confirm:hover {
    opacity: 0.9;
  }

  @media (max-width: 768px) {
    .requisition-info {
      grid-template-columns: 1fr;
    }

    .progress-steps {
      flex-direction: column;
      gap: 20px;
    }

    .progress-steps::before {
      display: none;
    }

    .step {
      flex-direction: row;
      gap: 10px;
    }

    .step-label {
      text-align: left;
      max-width: none;
    }

    .action-buttons {
      flex-direction: column;
    }

    .btn {
      width: 100%;
    }

    .modal-actions {
      flex-direction: column;
    }
  }
</style>
<div class="container">
  <div class="header">
    <h1>Requisition Details - REQ-{{ requisition.req_id }}</h1>
    <a
      href="{% url 'property_custodian_dashboard' %}?section=requisition"
      class="back-btn"
      >‚Üê Back to Requisitions</a
    >
  </div>

  <!-- Progress Bar -->
  <div class="card">
    <h2>Requisition Progress</h2>
    <div class="progress-container">
      <div class="progress-steps">
        <div
          class="progress-bar"
          style="width: {% widthratio current_status_index|add:1 progress_steps|length 100 %}%"
        ></div>
        {% for step in progress_steps %}
        <div
          class="step {% if step.active %}active{% elif forloop.counter0 < current_status_index %}completed{% endif %}"
        >
          <div class="step-circle">
            {% if forloop.counter0 < current_status_index %}‚úì{% else %}{{
            forloop.counter }}{% endif %}
          </div>
          <div class="step-label">{{ step.label }}</div>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>

  <!-- Requisition Items Table -->
  <div class="card">
    <h2>Requested Materials</h2>
    <table class="table">
      <thead>
        <tr>
          <th>Items</th>
          <th>Specification</th>
          <th>Unit Description</th>
          <th>Quantity</th>
        </tr>
      </thead>
      <tbody>
        {% for item in requisition_items %}
        <tr>
          <td>{{ item.product.prod_name }}</td>

          <td class="specs-cell">
            {% if item.product.product_specification_set.all %}
            <div class="specs-container">
              {% for spec in item.product.product_specification_set.all %}
              <div class="spec-item">
                <strong>{{ spec.spec_name }}:</strong> {{ spec.spec_value }}
              </div>
              {% endfor %}
            </div>
            {% else %}
            <span class="no-specs">No specifications available</span>
            {% endif %}
          </td>

          <td>{{ item.product.prod_desc }}</td>
          <td>{{ item.quantity }}</td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="4" style="text-align: center; color: #717182">
            No items found
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Requisition Information -->
  <div class="card">
    <h2>Requisition Information</h2>
    <div class="requisition-info">
      <div>
        <div class="info-group">
          <div class="info-label">Requisition ID</div>
          <div class="info-value">REQ-{{ requisition.req_id }}</div>
        </div>
        <div class="info-group">
          <div class="info-label">Requisition Type</div>
          <div class="info-value">{{ requisition.get_req_type_display }}</div>
        </div>
        <div class="info-group">
          <div class="info-label">Status</div>
          <div class="info-value">
            <div class="status-badges-container">
              <span
                class="status-badge {% if requisition.req_main_status == 'PENDING_CUSTODIAN' %}status-pending {% elif requisition.req_main_status == 'APPROVED_REQUISITION' %}status-approved {% else %}status-pending{% endif %}"
              >
                {{ requisition.get_req_main_status_display }}
              </span>

              {% if status_message %}
              <div
                class="status-blue"
                style="margin-top: 8px; display: inline-block"
              >
                {{ status_message }}
              </div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
      <div>
        <div class="info-group">
          <div class="info-label">Date Requested</div>
          <div class="info-value">
            {{ requisition.req_requested_date|date:"F d, Y" }}
          </div>
        </div>
        <div class="info-group">
          <div class="info-label">Requested By</div>
          <div class="info-value">
            {{ requisition.requested_by.user_fname }} {{
            requisition.requested_by.user_lname }}
          </div>
        </div>
        <div class="info-group">
          <div class="info-label">Branch</div>
          <div class="info-value">{{ requisition.branch.branch_name }}</div>
        </div>
      </div>
    </div>

    {% if inspection_message %}
    <div
      style="
        margin-top: 20px;
        padding: 15px;
        background: #f0f9ff;
        border-radius: 6px;
        border-left: 4px solid #2563eb;
      "
    >
      <div style="display: flex; align-items: center; gap: 10px">
        <div style="font-size: 20px">üì¶</div>
        <div>
          <strong style="color: #0369a1">Inspection Status:</strong>
          <p style="margin-top: 5px; color: #030213">
            {{ inspection_message }}
          </p>
          {% if po_info %}
          <div style="margin-top: 10px; font-size: 14px; color: #717182">
            PO ID: <strong>PO-{{ po_info.po_id }}</strong> | Supplier:
            <strong>{{ po_info.supplier }}</strong>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
    {% endif %} {% if requisition.req_notes %}
    <div class="info-group">
      <div class="info-label">Notes</div>
      <div class="info-value">{{ requisition.req_notes }}</div>
    </div>
    {% endif %}

    <!-- Action Buttons -->
    {% if show_buttons %}
    <div class="action-buttons"></div>
    {% endif %}

    <!-- Action Buttons -->
    {% if show_buttons %}
    <div class="action-buttons">
      {% if show_property_custodian_buttons %}
      <!-- Property Custodian Buttons -->
      <button type="button" class="btn reject-btn" name="reject-btn">
        Reject
      </button>
      <button type="button" class="btn approve-btn" name="approve-btn">
        Approve
      </button>
      <button
        type="button"
        class="btn approve-management-btn"
        name="approve-management-btn"
      >
        Approve and send to Management
      </button>

      {% elif show_to_be_delivered_buttons %}
      <!-- FIXED: Changed class from approve-btn to received-btn -->
      <button
        type="button"
        class="btn received-btn"
        name="approve-delivery-btn"
      >
        Received
      </button>

      {% elif show_inspection_buttons %}
      <button type="button" class="btn inspect-btn" name="inspect-btn">
        Start Inspection
      </button>

      {% elif show_delivery_received_buttons %}
      <!-- Delivery Received button (for IN_TRANSIT status) -->
      <button
        type="button"
        class="btn delivery-received-btn"
        name="delivery-received-btn"
      >
        Delivery Received
      </button>

      {% elif show_top_management_buttons %}
      <!-- Top Management Buttons -->
      <button type="button" class="btn reject-btn" name="reject-btn">
        Reject
      </button>
      <button type="button" class="btn approve-btn" name="approve-btn">
        Approve
      </button>

      {% elif show_purchase_management_buttons %}
      <!-- Purchase Management Button -->
      <button type="button" class="btn create-rfq-btn" name="create-rfq-btn">
        Create RFQ
      </button>

      {% elif show_complete_buttons %}
      <!-- Branch manager complete  Button -->
      <button type="button" class="btn complete-btn" name="complete-btn">
        Complete Requisition
      </button>
      {% endif %}
    </div>
    {% endif %}
  </div>
</div>

<!-- Reject Modal -->
<div id="rejectModal" class="modal">
  <div class="modal-content">
    <h3>Reject Requisition</h3>
    <p>Please provide a reason for rejecting this requisition:</p>
    <textarea
      id="rejectReason"
      placeholder="Enter rejection reason..."
    ></textarea>
    <div class="modal-actions">
      <button
        type="button"
        class="btn modal-cancel"
        onclick="closeModal('rejectModal')"
      >
        Cancel
      </button>
      <button type="button" class="btn modal-confirm" onclick="confirmReject()">
        Confirm Reject
      </button>
    </div>
  </div>
</div>

<!-- Approve Modal -->
<div id="approveModal" class="modal">
  <div class="modal-content">
    <h3>Approve Requisition</h3>
    <p>Are you sure you want to approve this requisition?</p>
    <div class="modal-actions">
      <button
        type="button"
        class="btn modal-cancel"
        onclick="closeModal('approveModal')"
      >
        Cancel
      </button>
      <button
        type="button"
        class="btn modal-confirm approve"
        onclick="confirmApprove()"
      >
        Confirm Approve
      </button>
    </div>
  </div>
</div>

<!-- Approve to Management Modal -->
<div id="approveManagementModal" class="modal">
  <div class="modal-content">
    <h3>Approve and Send to Management</h3>
    <p>
      Are you sure you want to approve this requisition and send it to
      management for final approval?
    </p>
    <div class="modal-actions">
      <button
        type="button"
        class="btn modal-cancel"
        onclick="closeModal('approveManagementModal')"
      >
        Cancel
      </button>
      <button
        type="button"
        class="btn modal-confirm approve-management"
        onclick="confirmApproveManagement()"
      >
        Confirm
      </button>
    </div>
  </div>
</div>

<!-- Received Confirmation Modal -->
<div id="receivedModal" class="modal">
  <div class="modal-content">
    <h3>Confirm Receipt</h3>
    <p>
      Are you sure you want to confirm that you have received these products?
      This will move the requisition to Inspection status.
    </p>
    <div class="modal-actions">
      <button
        type="button"
        class="btn modal-cancel"
        onclick="closeModal('receivedModal')"
      >
        Cancel
      </button>
      <button
        type="button"
        class="btn modal-confirm approve"
        onclick="confirmReceived()"
      >
        Confirm Receipt
      </button>
    </div>
  </div>
</div>

<!-- Delivery Received Confirmation Modal -->
<div id="deliveryReceivedModal" class="modal">
  <div class="modal-content">
    <h3>Confirm Delivery Received</h3>
    <p>
      Are you sure you want to confirm that the delivery has been received? This
      will mark the requisition as FULFILLED.
    </p>
    <div class="modal-actions">
      <button
        type="button"
        class="btn modal-cancel"
        onclick="closeModal('deliveryReceivedModal')"
      >
        Cancel
      </button>
      <button
        type="button"
        class="btn modal-confirm approve"
        onclick="confirmDeliveryReceived()"
      >
        Confirm Receipt
      </button>
    </div>
  </div>
</div>

<!-- Complete Requisition Modal -->
<div id="completeModal" class="modal">
  <div class="modal-content">
    <h3>Complete Requisition</h3>
    <p>
      Are you sure you want to mark this requisition as fulfilled? This will:
    </p>
    <ul style="margin: 10px 0 20px 20px">
      <li>Mark all linked requisitions as FULFILLED</li>
      <li>Add delivery items to inventory</li>
      <li>Update delivery status to DELIVERED</li>
    </ul>
    <div class="modal-actions">
      <button
        type="button"
        class="btn modal-cancel"
        onclick="closeModal('completeModal')"
      >
        Cancel
      </button>
      <button
        type="button"
        class="btn modal-confirm approve"
        onclick="confirmComplete()"
      >
        Complete Requisition
      </button>
    </div>
  </div>
</div>

<script>
  // Calculate progress bar width dynamically
  document.addEventListener('DOMContentLoaded', function() {
      const completedSteps = document.querySelectorAll('.step.completed').length;
      const activeSteps = document.querySelectorAll('.step.active').length;
      const totalSteps = document.querySelectorAll('.step').length;
      const progressBar = document.querySelector('.progress-bar');
      const completeBtn = document.querySelector('.complete-btn');


      if (totalSteps > 1) {
          const currentStepCount = completedSteps + (activeSteps > 0 ? 1 : 0);
          const progressWidth = ((currentStepCount - 1) / (totalSteps - 1)) * 100;
          progressBar.style.width = Math.max(0, progressWidth) + '%';
      }

      // Add event listeners to buttons (only if they exist)
      const rejectBtn = document.querySelector('.reject-btn');
      if (rejectBtn) {
          rejectBtn.addEventListener('click', function() {
              openModal('rejectModal');
          });
      }

      const approveBtn = document.querySelector('.approve-btn');
      if (approveBtn) {
          approveBtn.addEventListener('click', function() {
              openModal('approveModal');
          });
      }

      const deliveryReceivedBtn = document.querySelector('.delivery-received-btn');
      if (deliveryReceivedBtn) {
          deliveryReceivedBtn.addEventListener('click', function() {
              openModal('deliveryReceivedModal');
          });
      }

      if (completeBtn) {
          completeBtn.addEventListener('click', function() {
              openModal('completeModal');
          });
      }

      const approveManagementBtn = document.querySelector('.approve-management-btn');
      if (approveManagementBtn) {
          approveManagementBtn.addEventListener('click', function() {
              openModal('approveManagementModal');
          });
      }

      // Add event listener for Create RFQ button
      const createRfqBtn = document.querySelector('.create-rfq-btn');
      if (createRfqBtn) {
          createRfqBtn.addEventListener('click', function() {
              alert('Create RFQ functionality will be implemented later.');
          });
      }

      // FIXED: Changed selector to target received-btn specifically
      const receivedBtn = document.querySelector('.received-btn');
      if (receivedBtn) {
          receivedBtn.addEventListener('click', function() {
              openModal('receivedModal');
          });
      }

      // Add event listener for Start Inspection button
      const inspectBtn = document.querySelector('.inspect-btn');
      if (inspectBtn) {
          inspectBtn.addEventListener('click', function() {
              startInspection();
          });
      }
  });

  // Complete Requisition function
  function confirmComplete() {
      const reqId = {{ requisition.req_id }};
      const confirmBtn = document.querySelector('#completeModal .modal-confirm');
      confirmBtn.disabled = true;
      confirmBtn.textContent = 'Processing...';

      fetch(`/requisition/${reqId}/complete/`, {
          method: 'POST',
          headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': getCSRFToken()
          }
      })
      .then(response => response.json())
      .then(data => {
          if (data.success) {
              alert(data.message);
              closeModal('completeModal');
              window.location.reload();
          } else {
              alert('Error: ' + data.error);
              confirmBtn.disabled = false;
              confirmBtn.textContent = 'Complete Requisition';
          }
      })
      .catch(error => {
          console.error('Error:', error);
          alert('Failed to complete requisition. Please try again.');
          confirmBtn.disabled = false;
          confirmBtn.textContent = 'Complete Requisition';
      });
  }

  // Modal functions
  function openModal(modalId) {
      document.getElementById(modalId).style.display = 'flex';
  }

  function closeModal(modalId) {
      document.getElementById(modalId).style.display = 'none';
      if (modalId === 'rejectModal') {
          document.getElementById('rejectReason').value = '';
      }
  }

  // Close modal when clicking outside
  window.addEventListener('click', function(event) {
      const modals = document.querySelectorAll('.modal');
      modals.forEach(modal => {
          if (event.target === modal) {
              modal.style.display = 'none';
              if (modal.id === 'rejectModal') {
                  document.getElementById('rejectReason').value = '';
              }
          }
      });
  });

  // Confirmation functions
  function confirmReject() {
      const rejectReason = document.getElementById('rejectReason').value.trim();

      if (!rejectReason) {
          alert('Please provide a reason for rejection.');
          return;
      }

      alert('Reject functionality will be implemented later.');
      closeModal('rejectModal');
  }

  function confirmApprove() {
      const reqId = {{ requisition.req_id }};
      const confirmBtn = document.querySelector('#approveModal .modal-confirm');
      confirmBtn.disabled = true;
      confirmBtn.textContent = 'Processing...';

      fetch(`/requisition/${reqId}/approve/`, {
          method: 'POST',
          headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': getCSRFToken()
          }
      })
      .then(response => response.json())
      .then(data => {
          if (data.success) {
              alert(data.message);
              closeModal('approveModal');
              // Reload page to show updated status and progress
              window.location.reload();
          } else {
              alert('Error approving requisition: ' + data.error);
              confirmBtn.disabled = false;
              confirmBtn.textContent = 'Confirm Approve';
          }
      })
      .catch(error => {
          console.error('Error:', error);
          alert('Failed to approve requisition. Please try again.');
          confirmBtn.disabled = false;
          confirmBtn.textContent = 'Confirm Approve';
      });
  }

  // Add this new function
  function confirmDeliveryReceived() {
      const reqId = {{ requisition.req_id }};
      const confirmBtn = document.querySelector('#deliveryReceivedModal .modal-confirm');
      confirmBtn.disabled = true;
      confirmBtn.textContent = 'Processing...';

      fetch(`/requisition/${reqId}/confirm-delivery-received/`, {
          method: 'POST',
          headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': getCSRFToken()
          }
      })
      .then(response => response.json())
      .then(data => {
          if (data.success) {
              alert(data.message);
              closeModal('deliveryReceivedModal');
              window.location.reload();
          } else {
              alert('Error confirming delivery: ' + data.error);
              confirmBtn.disabled = false;
              confirmBtn.textContent = 'Confirm Receipt';
          }
      })
      .catch(error => {
          console.error('Error:', error);
          alert('Failed to confirm delivery. Please try again.');
          confirmBtn.disabled = false;
          confirmBtn.textContent = 'Confirm Receipt';
      });
  }



  function confirmApproveManagement() {
      const reqId = {{ requisition.req_id }};
      const confirmBtn = document.querySelector('#approveManagementModal .modal-confirm');
      confirmBtn.disabled = true;
      confirmBtn.textContent = 'Processing...';

      fetch(`/requisition/${reqId}/approve-management/`, {
          method: 'POST',
          headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': getCSRFToken()
          }
      })
      .then(response => response.json())
      .then(data => {
          if (data.success) {
              alert(data.message);
              closeModal('approveManagementModal');
              // Reload page to show updated status and progress
              window.location.reload();
          } else {
              alert('Error: ' + data.error);
              confirmBtn.disabled = false;
              confirmBtn.textContent = 'Confirm';
          }
      })
      .catch(error => {
          console.error('Error:', error);
          alert('Failed to send to management. Please try again.');
          confirmBtn.disabled = false;
          confirmBtn.textContent = 'Confirm';
      });
  }

  function confirmReceived() {
      const reqId = {{ requisition.req_id }};
      const confirmBtn = document.querySelector('#receivedModal .modal-confirm');
      confirmBtn.disabled = true;
      confirmBtn.textContent = 'Processing...';

      fetch(`/requisition/${reqId}/received/`, {
          method: 'POST',
          headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': getCSRFToken()
          }
      })
      .then(response => response.json())
      .then(data => {
          if (data.success) {
              alert(data.message);
              closeModal('receivedModal');
              window.location.reload();
          } else {
              alert('Error confirming receipt: ' + data.error);
              confirmBtn.disabled = false;
              confirmBtn.textContent = 'Confirm Receipt';
          }
      })
      .catch(error => {
          console.error('Error:', error);
          alert('Failed to confirm receipt. Please try again.');
          confirmBtn.disabled = false;
          confirmBtn.textContent = 'Confirm Receipt';
      });
  }

  // Start Inspection function
  function startInspection() {
      const reqId = {{ requisition.req_id }};
      const inspectBtn = document.querySelector('.inspect-btn');
      inspectBtn.disabled = true;
      inspectBtn.textContent = 'Checking...';

      console.log('Starting inspection check for req:', reqId);

      fetch(`/requisition/${reqId}/start-inspection/`, {
          method: 'POST',
          headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': getCSRFToken()
          }
      })
      .then(response => {
          console.log('Response status:', response.status);
          if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
          }
          return response.json();
      })
      .then(data => {
          console.log('API Response:', data);
          if (data.success) {
              console.log('Inspection started successfully, redirecting...');
              // Redirect to inspection page ONLY if successful
              window.location.href = `/inspection/${reqId}/`;
          } else {
              console.log('Inspection failed:', data.error);
              alert('Error starting inspection: ' + data.error);
              inspectBtn.disabled = false;
              inspectBtn.textContent = 'Start Inspection';
          }
      })
      .catch(error => {
          console.error('Fetch error:', error);
          alert('Failed to start inspection. Please try again.');
          inspectBtn.disabled = false;
          inspectBtn.textContent = 'Start Inspection';
      });
  }

      function getCSRFToken() {
          let csrfToken = '';
          const cookies = document.cookie.split(';');
          for (let cookie of cookies) {
              const [name, value] = cookie.trim().split('=');
              if (name === 'csrftoken') {
                  csrfToken = value;
                  break;
              }
          }
          return csrfToken;
      }
</script>
{% endblock %}
