{% extends "main/base.html" %}
{% block page_content %}
<style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

    * {
        font-family: 'Inter', sans-serif;
    }

    /* Page Header */
    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-bottom: 20px;
    }

    .page-title h1 {
        font-size: 28px;
        font-weight: 700;
        color: #1f2937;
        margin: 0 0 4px 0;
    }

    .page-description {
        font-size: 14px;
        color: #6b7280;
        margin: 0;
    }

    .header-actions {
        display: flex;
        gap: 10px;
    }

    .create-btn, .history-btn {
        border: none;
        padding: 10px 18px;
        font-size: 14px;
        font-weight: 500;
        border-radius: 8px;
        cursor: pointer;
        display: flex;
        gap: 8px;
        align-items: center;
        transition: all 0.2s ease;
    }

    .create-btn {
        background-color: #1a2332;
        color: white;
    }

    .create-btn:hover {
        background-color: #060607;
    }

    .history-btn {
        background-color: #eff6ff;
        color: #2563eb;
        border: 1px solid #dbeafe;
    }

    .history-btn:hover {
        background-color: #dbeafe;
    }

    /* Search and Filter Section */
    .search-filter-section {
        display: flex;
        gap: 12px;
        align-items: center;
        margin-bottom: 20px;
        padding: 16px 20px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        flex-wrap: wrap;
    }

    .search-box {
        flex: 1;
        position: relative;
        min-width: 250px;
    }

    .search-box input {
        width: 100%;
        padding: 10px 12px 10px 38px;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        font-size: 14px;
        color: #374151;
        background: #fafafa;
        transition: all 0.2s;
    }

    .search-box input:focus {
        outline: none;
        border-color: #3b82f6;
        background: white;
    }

    .search-box i {
        position: absolute;
        left: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: #9ca3af;
        font-size: 14px;
    }

    .filter-group {
        display: flex;
        gap: 10px;
        align-items: center;
    }

    .filter-dropdown {
        position: relative;
    }

    .filter-dropdown select {
        padding: 10px 16px;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        background: white;
        font-size: 14px;
        color: #374151;
        cursor: pointer;
        font-weight: 500;
        min-width: 180px;
        transition: all 0.2s;
    }

    .filter-dropdown select:hover {
        border-color: #d1d5db;
        background: #f9fafb;
    }

    .filter-dropdown select:focus {
        outline: none;
        border-color: #3b82f6;
    }

    /* Modern Table Design */
    .table-container {
        background: #ffffff;
        border-radius: 12px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        overflow: hidden;
        border: 1px solid #e5e7eb;
    }

    .inventory-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
        color: #374151;
    }

    .inventory-table thead th {
        background: #f9fafb;
        text-align: left;
        padding: 14px 16px;
        font-weight: 600;
        color: #6b7280;
        font-size: 13px;
        text-transform: uppercase;
        letter-spacing: 0.025em;
        border-bottom: 1px solid #e5e7eb;
    }

    .inventory-table tbody tr {
        border-bottom: 1px solid #f3f4f6;
        transition: background-color 0.15s;
    }

    .inventory-table tbody tr:hover {
        background: #f9fafb;
    }

    .inventory-table tbody tr:last-child {
        border-bottom: none;
    }

    .inventory-table tbody td {
        padding: 16px;
        color: #1f2937;
        font-size: 14px;
        vertical-align: top;
    }

    .product-name-cell {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .product-name {
        font-weight: 600;
        color: #111827;
        font-size: 14px;
    }

    .product-sku {
        font-size: 12px;
        color: #6b7280;
        font-family: 'Courier New', monospace;
    }

    .specs-container {
        display: flex;
        flex-direction: column;
        gap: 4px;
        max-width: 200px;
    }

    .spec-item {
        font-size: 13px;
        color: #4b5563;
    }

    .spec-item strong {
        color: #1f2937;
        font-weight: 600;
    }

    .no-specs {
        color: #9ca3af;
        font-style: italic;
        font-size: 13px;
    }

    .quantity-cell {
        font-weight: 600;
        color: #111827;
    }

    .quantity-cell .unit {
        font-weight: 400;
        color: #6b7280;
        font-size: 13px;
    }

    .price-cell {
        font-weight: 600;
        color: #059669;
    }

    .branch-cell {
        font-weight: 500;
        color: #4b5563;
    }

    /* Action Buttons */
    .action-buttons {
        display: flex;
        gap: 6px;
        flex-wrap: wrap;
    }

    .action-btn {
        padding: 7px 14px;
        border-radius: 6px;
        font-size: 13px;
        font-weight: 500;
        border: 1px solid;
        cursor: pointer;
        transition: all 0.2s;
        white-space: nowrap;
    }

    .btn-stock-in {
        background: #ecfdf5;
        color: #059669;
        border-color: #d1fae5;
    }

    .btn-stock-in:hover {
        background: #d1fae5;
        border-color: #a7f3d0;
    }

    .btn-stock-out {
        background: #fef2f2;
        color: #dc2626;
        border-color: #fecaca;
    }

    .btn-stock-out:hover {
        background: #fecaca;
        border-color: #fca5a5;
    }

    .btn-remove {
        background: #f3f4f6;
        color: #6b7280;
        border-color: #e5e7eb;
    }

    .btn-remove:hover {
        background: #e5e7eb;
        border-color: #d1d5db;
        color: #374151;
    }

    /* Disabled Action Buttons */
    .action-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        background: #f3f4f6;
        color: #9ca3af;
        border-color: #e5e7eb;
    }

    .action-btn:disabled:hover {
        background: #f3f4f6;
        border-color: #e5e7eb;
        color: #9ca3af;
    }

    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #9ca3af;
    }

    .empty-state i {
        font-size: 48px;
        margin-bottom: 16px;
        opacity: 0.3;
    }

    .empty-state p {
        font-size: 15px;
        margin: 0;
    }

    /* Modal Styles */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.25);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 999;
    }

    .modal-container {
        width: 520px;
        max-width: 90%;
        background: #fff;
        border-radius: 18px;
        padding: 25px 30px;
        box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        animation: fadeIn 0.25s ease;
        max-height: 90vh;
        overflow-y: auto;
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .modal-header h2 {
        font-size: 20px;
        margin: 0;
        font-weight: 600;
        color: #1f2937;
    }

    .close-btn {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: #6b7280;
        padding: 0;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 6px;
        transition: all 0.2s;
    }

    .close-btn:hover {
        background: #f3f4f6;
        color: #374151;
    }

    .modal-body {
        margin-top: 18px;
    }

    .form-group {
        margin-bottom: 15px;
    }

    .form-group label {
        font-size: 14px;
        color: #374151;
        font-weight: 500;
        display: block;
        margin-bottom: 6px;
    }

    .form-group input,
    .form-group textarea,
    .form-group select {
        width: 100%;
        padding: 10px 12px;
        border-radius: 8px;
        border: 1px solid #e5e7eb;
        background: #fafafa;
        font-size: 14px;
        font-family: 'Inter', sans-serif;
        color: #374151;
    }

    .form-group input:focus,
    .form-group textarea:focus,
    .form-group select:focus {
        outline: none;
        border-color: #3b82f6;
        background: white;
    }

    .form-row {
        display: flex;
        gap: 15px;
    }

    .form-row .half {
        flex: 1;
    }

    .specification-group {
        margin-bottom: 10px;
    }

    .spec-row {
        display: flex;
        gap: 10px;
        align-items: flex-end;
        margin-bottom: 10px;
    }

    .spec-input-group {
        flex: 1;
    }

    .spec-input-group label {
        font-size: 12px;
        margin-bottom: 3px;
    }

    .spec-input-group input {
        margin-bottom: 0;
    }

    .remove-spec-btn {
        background: #fef2f2;
        color: #dc2626;
        border: 1px solid #fecaca;
        padding: 8px 12px;
        border-radius: 6px;
        cursor: pointer;
        height: fit-content;
        margin-bottom: 10px;
        font-size: 13px;
        font-weight: 500;
        transition: all 0.2s;
    }

    .remove-spec-btn:hover {
        background: #fecaca;
    }

    .add-spec-btn {
        background: #ecfdf5;
        color: #059669;
        border: 1px solid #d1fae5;
        padding: 8px 16px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.2s;
        width: 100%;
        margin-bottom: 15px;
    }

    .add-spec-btn:hover {
        background: #d1fae5;
    }

    .modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        margin-top: 20px;
    }

    .btn-cancel {
        padding: 10px 18px;
        background: #f3f4f6;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        font-weight: 500;
        color: #374151;
        font-size: 14px;
        transition: all 0.2s;
    }

    .btn-cancel:hover {
        background: #e5e7eb;
    }

    .btn-save {
        padding: 10px 20px;
        background: #2563eb;
        color: #fff;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        font-weight: 500;
        font-size: 14px;
        transition: all 0.2s;
    }

    .btn-save:hover {
        background: #1d4ed8;
    }

    /* History Modal Specific Styles */
    .history-modal .modal-container {
        width: 900px;
        max-width: 95%;
    }

    .date-filter {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
        align-items: flex-end;
    }

    .date-filter .form-group {
        flex: 1;
        margin-bottom: 0;
    }

    .date-filter button {
        padding: 10px 18px;
        background: #2563eb;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 500;
        font-size: 14px;
        transition: all 0.2s;
    }

    .date-filter button:hover {
        background: #1d4ed8;
    }

    .history-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
    }

    .history-table thead th {
        background: #f9fafb;
        text-align: left;
        padding: 12px;
        font-weight: 600;
        color: #6b7280;
        font-size: 12px;
        text-transform: uppercase;
        border-bottom: 1px solid #e5e7eb;
    }

    .history-table tbody td {
        padding: 12px;
        border-bottom: 1px solid #f3f4f6;
        font-size: 13px;
        color: #374151;
    }

    .history-table tbody tr:last-child td {
        border-bottom: none;
    }

    .transaction-type {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
    }

    .transaction-type.stockin {
        background: #ecfdf5;
        color: #059669;
    }

    .transaction-type.stockout {
        background: #fef2f2;
        color: #dc2626;
    }

    @keyframes fadeIn {
        from { 
            opacity: 0; 
            transform: translateY(10px); 
        }
        to { 
            opacity: 1; 
            transform: translateY(0); 
        }
    }

    /* Responsive Design */
    @media (max-width: 768px) {
        .page-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 15px;
        }

        .search-filter-section {
            flex-direction: column;
            align-items: stretch;
        }

        .search-box {
            width: 100%;
        }

        .filter-group {
            flex-direction: column;
            width: 100%;
        }

        .filter-dropdown select {
            width: 100%;
        }

        .action-buttons {
            flex-direction: column;
        }

        .action-btn {
            width: 100%;
            justify-content: center;
        }
    }
</style>

<div class="page-header">
    <div class="page-title">
        <h1>Inventory Management</h1>
        <p class="page-description">Track and manage product stock levels across all branches.</p>
    </div>

    <div class="header-actions">
        <button class="history-btn" onclick="openHistoryModal()">
            <i class="fa-solid fa-clock-rotate-left"></i>
            Movement History
        </button>
        <button class="create-btn" onclick="openAddProductModal()">
            <i class="fa-solid fa-plus"></i>
            Add Product
        </button>
    </div>
</div>

<!-- Search and Filter Section -->
<div class="search-filter-section">
    <div class="search-box">
        <i class="fa-solid fa-search"></i>
        <input type="text" id="searchInput" placeholder="Search by product name or SKU...">
    </div>
    
    <div class="filter-group">
        <!-- Always show branch filter for everyone -->
        <div class="filter-dropdown">
            <select id="branchFilter">
                <option value="all">All Branches</option>
                {% for branch in branches %}
                    <option value="{{ branch.branch_id }}" {% if user.role.role_id == 2 and user.branch.branch_id == branch.branch_id %}selected{% endif %}>
                        {{ branch.branch_name }}
                    </option>
                {% endfor %}
            </select>
        </div>
        
        <div class="filter-dropdown">
            <select id="categoryFilter">
                <option value="all">All Categories</option>
                {% for cat in categories %}
                    <option value="{{ cat.prod_cat_name }}">{{ cat.prod_cat_name }}</option>
                {% endfor %}
            </select>
        </div>
    </div>
</div>

<!-- Table Container -->
<div class="table-container">
    <table class="inventory-table">
        <thead>
            <tr>
                <th>Product Name</th>
                <th>Specification</th>
                <th>Branch</th>
                <th>Quantity on Hand</th>
                <th>Retail Price</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="inventoryTableBody">
        {% if products %}
            {% for p in products %}
                <tr data-category="{{ p.product.category.prod_cat_name }}" 
                    data-branch="{{ p.branch.branch_id }}"
                    data-inventory-id="{{ p.inventory_id }}"
                    data-product-id="{{ p.product.prod_id }}"
                    data-branch-name="{{ p.branch.branch_name }}">
                    <td>
                        <div class="product-name-cell">
                            <span class="product-name">{{ p.product.prod_name }}</span>
                            <span class="product-sku">SKU: {{ p.product.prod_sku }}</span>
                        </div>
                    </td>
                    <td>
                        {% if p.product.product_specification_set.all %}
                            <div class="specs-container">
                                {% for spec in p.product.product_specification_set.all %}
                                    <div class="spec-item">
                                        <strong>{{ spec.spec_name }}:</strong> {{ spec.spec_value }}
                                    </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <span class="no-specs">No specifications</span>
                        {% endif %}
                    </td>
                    <td>
                        <div class="branch-cell">{{ p.branch.branch_name }}</div>
                    </td>
                    <td>
                        <div class="quantity-cell">
                            {{ p.quantity_on_hand }} <span class="unit">{{ p.product.prod_unit_of_measure }}</span>
                        </div>
                    </td>
                    <td>
                        <div class="price-cell">₱{{ p.product.prod_retail_price }}</div>
                    </td>
                    <td>
                        <div class="action-buttons">
                            <button class="action-btn btn-stock-in" 
                                    onclick="openStockModal(this, 'in')"
                                    data-branch="{{ p.branch.branch_id }}">
                                <i class="fa-solid fa-arrow-down"></i> Stock In
                            </button>
                            <button class="action-btn btn-stock-out" 
                                    onclick="openStockModal(this, 'out')"
                                    data-branch="{{ p.branch.branch_id }}">
                                <i class="fa-solid fa-arrow-up"></i> Stock Out
                            </button>
                            <button class="action-btn btn-remove" 
                                    onclick="removeProduct(this)"
                                    data-branch="{{ p.branch.branch_id }}">
                                <i class="fa-solid fa-xmark"></i> Remove
                            </button>
                        </div>
                    </td>
                </tr>
            {% endfor %}
        {% else %}
            <tr>
                <td colspan="6">
                    <div class="empty-state">
                        <i class="fa-solid fa-box-open"></i>
                        <p>No products found. Click "Add Product" to add inventory items.</p>
                    </div>
                </td>
            </tr>
        {% endif %}
        </tbody>
    </table>
</div>

<!-- Stock In/Out Modal -->
<div id="stockModal" class="modal-overlay">
    <div class="modal-container">
        <div class="modal-header">
            <h2 id="stockModalTitle">Stock In</h2>
            <button type="button" class="close-btn" onclick="closeStockModal()">&times;</button>
        </div>

        <div class="modal-body">
            <div class="form-group">
                <label>Product Name</label>
                <input type="text" id="stockProductName" readonly style="background: #f3f4f6; cursor: not-allowed;">
            </div>

            <div class="form-group">
                <label>Branch</label>
                <input type="text" id="stockProductBranch" readonly style="background: #f3f4f6; cursor: not-allowed;">
            </div>

            <div class="form-group">
                <label>Quantity</label>
                <input type="number" id="stockQuantity" min="1" placeholder="Enter quantity">
            </div>
        </div>

        <div class="modal-footer">
            <button type="button" class="btn-cancel" onclick="closeStockModal()">Cancel</button>
            <button type="button" class="btn-save" onclick="saveStockAction()">Save</button>
        </div>
    </div>
</div>

<!-- Add Product to Inventory Modal -->
<div id="addProductModal" class="modal-overlay">
    <div class="modal-container">
        <div class="modal-header">
            <h2>Add Product to Inventory</h2>
            <button type="button" class="close-btn" onclick="closeAddProductModal()">&times;</button>
        </div>

        <div class="modal-body">
            <div class="form-group">
                <label>Branch</label>
                <select id="addProductBranch"
                        onchange="loadAvailableProducts()"
                        {% if user.role_id == 2 %}disabled{% endif %}>
                    <option value="" disabled selected>Select branch</option>
                    {% for branch in branches %}
                        <option value="{{ branch.branch_id }}">{{ branch.branch_name }}</option>
                    {% endfor %}
                </select>

            </div>

            <div class="form-group">
                <label>Select Product</label>
                <select id="addProductSelect" disabled>
                    <option value="" disabled selected>Select a product</option>
                </select>
                <small style="color: #6b7280; font-size: 12px; margin-top: 4px; display: block;">
                    Only shows products not already in this branch's inventory
                </small>
            </div>

            <div id="selectedProductDetails" style="display: none; margin-top: 20px; padding: 15px; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb;">
                <h4 style="margin-top: 0; margin-bottom: 10px; font-size: 16px; color: #1f2937;">Product Details</h4>
                <div class="form-row">
                    <div class="form-group half">
                        <label style="font-size: 12px; color: #6b7280;">SKU</label>
                        <div id="selectedProductSku" style="font-weight: 600; color: #1f2937;"></div>
                    </div>
                    <div class="form-group half">
                        <label style="font-size: 12px; color: #6b7280;">Unit of Measure</label>
                        <div id="selectedProductUnit" style="font-weight: 600; color: #1f2937;"></div>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group half">
                        <label style="font-size: 12px; color: #6b7280;">Cost Price</label>
                        <div id="selectedProductCost" style="font-weight: 600; color: #1f2937;"></div>
                    </div>
                    <div class="form-group half">
                        <label style="font-size: 12px; color: #6b7280;">Retail Price</label>
                        <div id="selectedProductPrice" style="font-weight: 600; color: #059669;"></div>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group half">
                        <label style="font-size: 12px; color: #6b7280;">Category</label>
                        <div id="selectedProductCategory" style="font-weight: 600; color: #1f2937;"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal-footer">
            <button type="button" class="btn-cancel" onclick="closeAddProductModal()">Cancel</button>
            <button type="button" class="btn-save" onclick="addProductToInventory()" disabled id="addProductBtn">Add to Inventory</button>
        </div>
    </div>
</div>

<!-- Movement History Modal -->
<div id="historyModal" class="modal-overlay history-modal">
    <div class="modal-container">
        <div class="modal-header">
            <h2>Inventory Movement History</h2>
            <button type="button" class="close-btn" onclick="closeHistoryModal()">&times;</button>
        </div>

        <div class="modal-body">
            <div class="date-filter">
                <div class="form-group">
                    <label>From Date</label>
                    <input type="date" id="historyFromDate">
                </div>
                <div class="form-group">
                    <label>To Date</label>
                    <input type="date" id="historyToDate">
                </div>
                <button onclick="filterHistory()">Filter</button>
            </div>

            <table class="history-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Product</th>
                        <th>Type</th>
                        <th>Quantity</th>
                        <th>Unit Cost</th>
                        <th>User</th>
                        <th>Branch</th>
                    </tr>
                </thead>
                <tbody id="historyTableBody">
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px;">
                            <span style="color: #9ca3af;">Select date range and click filter to view history</span>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="modal-footer">
            <button type="button" class="btn-cancel" onclick="closeHistoryModal()">Close</button>
        </div>
    </div>
</div>

<script>
    const userId = "{{ user_id }}";
    const userRoleId = parseInt("{{ user.role.role_id|safe }}");
    const userBranchId = "{{ user.branch.branch_id|safe }}";
    let currentStockRow = null;
    let currentStockMode = "";

    document.addEventListener('DOMContentLoaded', function() {
        // For branch managers (role 2), set default branch filter to their branch
        if (userRoleId === 2) {
            document.getElementById('branchFilter').value = userBranchId;
        }
        filterTable();
    });

    // Search functionality
    document.getElementById('searchInput').addEventListener('input', filterTable);

    // Filter functionality
    document.getElementById('branchFilter').addEventListener('change', filterTable);
    document.getElementById('categoryFilter').addEventListener('change', filterTable);

    function filterTable() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const branchFilter = document.getElementById('branchFilter').value;
        const categoryFilter = document.getElementById('categoryFilter').value;

        const rows = document.querySelectorAll('#inventoryTableBody tr');
        let hasVisibleRows = false;

        rows.forEach(row => {
            if (row.children.length < 6) return;

            const productName = row.querySelector('.product-name')?.textContent.toLowerCase() || '';
            const productSku = row.querySelector('.product-sku')?.textContent.toLowerCase() || '';
            const rowBranch = row.getAttribute('data-branch');
            const rowCategory = row.getAttribute('data-category');

            const searchMatch = searchTerm === '' || productName.includes(searchTerm) || productSku.includes(searchTerm);
            const branchMatch = branchFilter === 'all' || rowBranch === branchFilter;
            const categoryMatch = categoryFilter === 'all' || rowCategory === categoryFilter;

            if (searchMatch && branchMatch && categoryMatch) {
                row.style.display = '';
                hasVisibleRows = true;
            } else {
                row.style.display = 'none';
            }
        });

        updateActionButtons(branchFilter);
    }

    function updateActionButtons(selectedBranch) {
        const rows = document.querySelectorAll('#inventoryTableBody tr');

        rows.forEach(row => {
            const actionCol = row.querySelector('.action-buttons');
            if (!actionCol) return;

            if (userRoleId === 1) {
                // Admin: always show buttons
                actionCol.style.display = '';
                actionCol.querySelectorAll('.action-btn').forEach(btn => {
                    btn.disabled = false;
                    btn.title = '';
                });
            } else if (userRoleId === 2) {
                const rowBranch = row.getAttribute('data-branch');
                const isUserBranch = rowBranch === userBranchId && (selectedBranch === userBranchId || selectedBranch === userBranchId.toString());

                // Show action column only if branch matches user's branch and branch filter matches
                actionCol.style.display = isUserBranch ? 'flex' : 'none';
                actionCol.querySelectorAll('.action-btn').forEach(btn => {
                    btn.disabled = !isUserBranch;
                    btn.title = !isUserBranch ? 'Action not allowed for this branch' : '';
                });
            }
        });
    }

    // Stock In/Out Modal Functions
    function openStockModal(button, mode) {
        if (button.disabled) {
            alert("You don't have permission to perform this action on this branch's inventory.");
            return;
        }

        currentStockRow = button.closest('tr');
        currentStockMode = mode;

        const productName = currentStockRow.querySelector('.product-name').textContent;
        const branchName = currentStockRow.getAttribute('data-branch-name');

        document.getElementById('stockModalTitle').textContent = mode === 'in' ? 'Stock In' : 'Stock Out';
        document.getElementById('stockProductName').value = productName;
        document.getElementById('stockProductBranch').value = branchName;
        document.getElementById('stockQuantity').value = '';
        document.getElementById('stockModal').style.display = 'flex';
    }

    function closeStockModal() {
        document.getElementById('stockModal').style.display = 'none';
        currentStockRow = null;
        currentStockMode = '';
    }

    async function saveStockAction() {
        const quantity = Number(document.getElementById('stockQuantity').value);

        if (quantity <= 0 || isNaN(quantity)) {
            alert("Quantity must be a positive number");
            return;
        }

        const inventoryId = currentStockRow.getAttribute("data-inventory-id");

        try {
            const response = await fetch("/inventory/stock_action/", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    inventory_id: inventoryId,
                    quantity: quantity,
                    action_type: currentStockMode,
                    user_id: userId
                })
            });

            const data = await response.json();

            if (response.ok && data.success) {
                alert(data.message || "Stock updated successfully!");
                const quantityCell = currentStockRow.querySelector('.quantity-cell');
                const unit = currentStockRow.querySelector('.unit').textContent;
                quantityCell.innerHTML = `${data.new_quantity} <span class="unit">${unit}</span>`;
                closeStockModal();
            } else {
                alert("Error: " + (data.error || "Failed to update stock"));
            }
        } catch (err) {
            alert("Failed to update stock: " + err.message);
            console.error("Stock update error:", err);
        }
    }

    // Remove Product Function
    async function removeProduct(button) {
        if (button.disabled) {
            alert("You don't have permission to remove products from this branch.");
            return;
        }

        const row = button.closest('tr');
        const productName = row.querySelector('.product-name').textContent;
        const productId = row.getAttribute('data-product-id');

        if (!confirm(`Are you sure you want to remove "${productName}"? This will make the product inactive.`)) return;

        try {
            const response = await fetch("/inventory/edit_product/", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ product_id: productId, prod_is_active: false, user_id: userId })
            });

            const data = await response.json();

            if (response.ok && data.success) {
                alert("Product has been removed successfully!");
                row.remove();

                const visibleRows = document.querySelectorAll('#inventoryTableBody tr[data-product-id]');
                if (visibleRows.length === 0) {
                    document.getElementById('inventoryTableBody').innerHTML = `
                        <tr>
                            <td colspan="6">
                                <div class="empty-state">
                                    <i class="fa-solid fa-box-open"></i>
                                    <p>No products found. Click "Add Product" to add inventory items.</p>
                                </div>
                            </td>
                        </tr>
                    `;
                }
            } else {
                alert("Error: " + (data.error || "Failed to remove product"));
            }
        } catch (err) {
            alert("Failed to remove product: " + err.message);
            console.error("Remove product error:", err);
        }
    }

    // Movement History Modal Functions
    function openHistoryModal() {
        document.getElementById('historyModal').style.display = 'flex';
        
        // Set default dates (last 30 days)
        const toDate = new Date();
        const fromDate = new Date();
        fromDate.setDate(fromDate.getDate() - 30);
        
        document.getElementById('historyToDate').valueAsDate = toDate;
        document.getElementById('historyFromDate').valueAsDate = fromDate;
    }

    function closeHistoryModal() {
        document.getElementById('historyModal').style.display = 'none';
    }

    async function filterHistory() {
        const fromDate = document.getElementById('historyFromDate').value;
        const toDate = document.getElementById('historyToDate').value;

        if (!fromDate || !toDate) {
            alert("Please select both start and end dates");
            return;
        }

        try {
            const response = await fetch(`/inventory/get_movement_history/?from_date=${fromDate}&to_date=${toDate}`, {
                method: "GET",
                headers: {
                    "Content-Type": "application/json"
                }
            });

            const data = await response.json();

            if (response.ok && data.success) {
                displayHistory(data.transactions);
            } else {
                alert("Error: " + (data.error || "Failed to load history"));
            }
        } catch (err) {
            alert("Failed to load history: " + err.message);
            console.error("History error:", err);
        }
    }

    function displayHistory(transactions) {
        const tbody = document.getElementById('historyTableBody');
        tbody.innerHTML = '';

        if (transactions.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="7" style="text-align: center; padding: 40px;">
                        <span style="color: #9ca3af;">No transactions found for the selected date range</span>
                    </td>
                </tr>
            `;
            return;
        }

        transactions.forEach(trans => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${trans.created_at}</td>
                <td>${trans.product_name}</td>
                <td>
                    <span class="transaction-type ${trans.trans_type}">
                        ${trans.trans_type === 'stockin' ? 'Stock In' : 'Stock Out'}
                    </span>
                </td>
                <td>${trans.quantity}</td>
                <td>₱${trans.unit_cost}</td>
                <td>${trans.user_name}</td>
                <td>${trans.branch_name}</td>
            `;
            tbody.appendChild(row);
        });
    }

    // Close modals when clicking outside
    document.getElementById('stockModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeStockModal();
        }
    });

    document.getElementById('addProductModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeAddProductModal();
        }
    });

    document.getElementById('historyModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeHistoryModal();
        }
    });

    function openAddProductModal() {
    // Reset fields
    document.getElementById('addProductBranch').value = '';
    document.getElementById('addProductSelect').innerHTML = '<option value="" disabled selected>Select a product</option>';
    document.getElementById('addProductSelect').disabled = true;
    document.getElementById('selectedProductDetails').style.display = 'none';
    document.getElementById('addProductBtn').disabled = true;
    
    // For branch managers, set default branch to their branch
    if (userRoleId === 2) {
        document.getElementById('addProductBranch').value = userBranchId;
        loadAvailableProducts();
    }
    
    document.getElementById('addProductModal').style.display = 'flex';
}

function closeAddProductModal() {
    document.getElementById('addProductModal').style.display = 'none';
}

async function loadAvailableProducts() {
    const branchId = document.getElementById('addProductBranch').value;
    
    if (!branchId) {
        document.getElementById('addProductSelect').disabled = true;
        document.getElementById('addProductSelect').innerHTML = '<option value="" disabled selected>Select a product</option>';
        document.getElementById('selectedProductDetails').style.display = 'none';
        document.getElementById('addProductBtn').disabled = true;
        return;
    }
    
    try {
        // Show loading state
        document.getElementById('addProductSelect').innerHTML = '<option value="" disabled>Loading products...</option>';
        
        const response = await fetch(`/inventory/get_products_not_in_inventory/?branch_id=${branchId}`, {
            method: "GET",
            headers: {
                "Content-Type": "application/json"
            }
        });
        
        const data = await response.json();
        
        if (response.ok && data.success) {
            const select = document.getElementById('addProductSelect');
            select.innerHTML = '<option value="" disabled selected>Select a product</option>';
            
            if (data.products.length === 0) {
                select.innerHTML = '<option value="" disabled>No products available to add</option>';
                select.disabled = true;
            } else {
                data.products.forEach(product => {
                    const option = document.createElement('option');
                    option.value = product.prod_id;
                    option.textContent = `${product.prod_name} (${product.prod_sku})`;
                    option.setAttribute('data-product', JSON.stringify(product));
                    select.appendChild(option);
                });
                select.disabled = false;
                
                // Add event listener to show product details when selected
                select.addEventListener('change', function() {
                    const selectedOption = this.options[this.selectedIndex];
                    if (selectedOption.value) {
                        const productData = JSON.parse(selectedOption.getAttribute('data-product'));
                        showProductDetails(productData);
                        document.getElementById('addProductBtn').disabled = false;
                    } else {
                        document.getElementById('selectedProductDetails').style.display = 'none';
                        document.getElementById('addProductBtn').disabled = true;
                    }
                });
            }
        } else {
            alert("Error: " + (data.error || "Failed to load products"));
            document.getElementById('addProductSelect').innerHTML = '<option value="" disabled>Error loading products</option>';
        }
    } catch (err) {
        console.error("Error loading products:", err);
        alert("Failed to load products: " + err.message);
    }
}

function showProductDetails(product) {
    document.getElementById('selectedProductSku').textContent = product.prod_sku;
    document.getElementById('selectedProductUnit').textContent = product.prod_unit_of_measure;
    document.getElementById('selectedProductCost').textContent = '₱' + product.prod_current_cost;
    document.getElementById('selectedProductPrice').textContent = '₱' + product.prod_retail_price;
    document.getElementById('selectedProductCategory').textContent = product.category;
    
    document.getElementById('selectedProductDetails').style.display = 'block';
}

async function addProductToInventory() {
    const branchId = document.getElementById('addProductBranch').value;
    const productId = document.getElementById('addProductSelect').value;
    
    if (!branchId || !productId) {
        alert("Please select both branch and product");
        return;
    }
    
    try {
        const response = await fetch("/inventory/add_product_to_inventory/", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                branch_id: branchId,
                product_id: productId,
                user_id: userId
            })
        });
        
        const data = await response.json();
        
        if (response.ok && data.success) {
            alert(data.message || "Product added to inventory successfully!");
            closeAddProductModal();
            location.reload(); // Refresh to show the new inventory item
        } else {
            alert("Error: " + (data.error || "Failed to add product to inventory"));
        }
    } catch (err) {
        alert("Failed to add product: " + err.message);
        console.error("Add product to inventory error:", err);
    }
}    

</script>
{% endblock %}